ALTER PROCEDURE [dbo].[SP_AccessGroup_CURD]
@Id int = null,
@Name nvarchar(50)=null,
@CompanyId uniqueidentifier = null,
@Code nvarchar(50)='',
@Description nvarchar(500)='',
@AccessGroupTypeId nvarchar(max) = '',
@IsCanteen bit = 0,
@Isactive bit = 0,
@CreatedBy uniqueidentifier=null,
@ModifiedBy uniqueidentifier=null,
@ActionType nvarchar(20) = '',
@TempTable AS dbo.AccessGroupLevelTableType READONLY
AS

BEGIN
	IF @ActionType = 'Insert'  
	BEGIN  
		DECLARE @AccessGroupId INT;
		--Start DoorGroup
	    Insert into Tbl_Mstr_AccessGroup_Master
		(
			Name, CompanyId, Code,[Description],AccessGroupTypeId,Is_Canteen,IsDeleted,IsActive,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy
		) 
		values
		(
			@Name,@CompanyId, @Code,@Description,@AccessGroupTypeId,@IsCanteen,0,@Isactive,GETDATE(),GETDATE(),@CreatedBy,@ModifiedBy
		)
		SET @AccessGroupId =  @@IDENTITY

		INSERT INTO Tbl_Mstr_AccessGroup_level_Master (CompanyId,AccessGroupId,DoorGroupId,SessionId,IsDeleted,IsActive,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy)
        SELECT @CompanyId,@AccessGroupId,DoorGroupId, SessionId,0,@Isactive,GETDATE(),GETDATE(),@CreatedBy,@ModifiedBy FROM @TempTable

		--End DoorGroup
	END  
	IF @ActionType = 'Edit' OR @ActionType='Remote'
	BEGIN  
		select C.Id,C.CompanyId,C.Name,C.Code,C.Description,C.AccessGroupTypeId,C.Is_Canteen,
		C.CreatedBy,C.ModifiedBy,C.Isactive
		from Tbl_Mstr_AccessGroup_Master C 
		WHERE (C.Id=@Id or C.Code=@Code) and CompanyId=@CompanyId

		SELECT Id,CompanyId,DoorGroupId,SessionId FROM Tbl_Mstr_AccessGroup_level_Master WHere AccessGroupId = @Id
	END  
	IF @ActionType = 'Update'  
	BEGIN  
	--Start DoorGroup
		UPDATE Tbl_Mstr_AccessGroup_Master SET  
			Name = IsNull(@Name,Name), 
			Code = IsNull(@Code,Code), 
			[Description] = ISNULL(@Description,[Description]),
			AccessGroupTypeId = ISNULL(@AccessGroupTypeId,AccessGroupTypeId),
			Is_Canteen =  @IsCanteen,
			Isactive=@Isactive,
			ModifiedDate = GETDATE() 
		WHERE CompanyId = @CompanyId and Id=@Id

		DELETE FROM Tbl_Mstr_AccessGroup_level_Master WHERE AccessGroupId = @Id

		INSERT INTO Tbl_Mstr_AccessGroup_level_Master (CompanyId,AccessGroupId,DoorGroupId,SessionId,IsDeleted,IsActive,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy)
        SELECT @CompanyId,@Id,DoorGroupId, SessionId,0,@Isactive,GETDATE(),GETDATE(),@CreatedBy,@ModifiedBy FROM @TempTable

	--End DoorGroup
	END  
	IF @ActionType = 'Delete'  
	BEGIN  
		Delete from Tbl_Mstr_AccessGroup_Master Where Id = @Id
                Delete from Tbl_Mstr_AccessGroup_level_Master Where AccessGroupId = @Id
	END  
END

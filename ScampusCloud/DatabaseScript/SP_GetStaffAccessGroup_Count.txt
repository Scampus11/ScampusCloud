--exec SP_GetStaffAccessGroup_Count @CompanyId='A1B42BAF-8C3D-43DA-A5EB-47334EF958D2'
ALTER PROCEDURE [dbo].[SP_GetStaffAccessGroup_Count]
@Search nvarchar(max)='',
@DepartmentId INT = 0,
@page INT=1,
@pagesize INT=10,
@CompanyId nvarchar(100)=''
AS
BEGIN
SET NOCOUNT ON  
 DECLARE @FinalQuery NVARCHAR(MAX) = '', @SelectQuery NVARCHAR(MAX) = '',@TablesJoins NVARCHAR(MAX) = '', @WhereCaluse NVARCHAR(MAX) = '',@OrderByCaluse NVARCHAR(1000) = '',@GroupByCaluse NVARCHAR(1000) = ''
	
	SET @SelectQuery = @SelectQuery + ' SELECT COUNT(SM.Id) AS Count
		FROM Tbl_Mstr_Staff_Master SM WITH(NOLOCK) 
		LEFT JOIN Tbl_Mstr_StaffDepartment_Master SDM WITH(NOLOCK) ON SDM.Id = SM.DepartmentId 
		LEFT JOIN Tbl_Mstr_Staff_Access_Group_Control MSAG WITH(NOLOCK) ON MSAG.StaffId = SM.StaffId 
		--LEFT JOIN Tbl_Mstr_AccessGroup_Master MAS WITH(NOLOCK) ON CHARINDEX('','' + CAST(MAS.Id AS VARCHAR) + '','', '','' + MSAG.AccessGroupId + '','') > 0 '

	SET @WhereCaluse = @WhereCaluse + ' WHERE SM.CompanyId=@CompanyId'
	SET @GroupByCaluse += ' GROUP BY SM.Id'

    SET @FinalQuery += @SelectQuery + @TablesJoins + @WhereCaluse + @GroupByCaluse
	PRINT @FinalQuery
    EXECUTE sp_executesql @FinalQuery, N'@CompanyId nvarchar(100), @DepartmentId INT, @Search nvarchar(max), @page INT, @pagesize INT', 
        @CompanyId,@DepartmentId, @Search, @page, @pagesize
END
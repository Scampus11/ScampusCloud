CREATE PROCEDURE [dbo].[SP_Assign_StaffAccessGroup]
  @TempTable AS dbo.StaffAccessGroupType READONLY,
  @CreatedBy uniqueidentifier=null,
  @ModifiedBy uniqueidentifier=null,
  @Isactive bit = 0,
  @CompanyId uniqueidentifier = null,
  @StaffIds nvarchar(50) = null,
  @ActionType nvarchar(50) = null
AS

BEGIN
       IF(@ActionType = 'Assign')
	   BEGIN
	        INSERT INTO Tbl_Mstr_Staff_Access_Group_Control (StaffId,CompanyId,[name],AccessGroupId,BlockId,IsDeleted,IsActive,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy)
           SELECT T.StaffId,@CompanyId,T.[name],AccessGroup,null,0,@Isactive,GETDATE(),GETDATE(),@CreatedBy,@ModifiedBy FROM @TempTable as T
		   LEFT JOIN dbo.Tbl_Mstr_Staff_Access_Group_Control u ON T.StaffId = u.StaffId
		   WHERE u.StaffId IS NULL;

		   UPDATE u
           SET 
			u.[name] = t.[name],
			u.AccessGroupId = t.AccessGroup,
			u.CanteenTypeId = t.CanteenTypeId,
			u.IsDeleted = 0,
			u.IsActive = @Isactive,
			u.ModifiedDate = GETDATE(),
			u.ModifiedBy = @ModifiedBy
			FROM
				dbo.Tbl_Mstr_Staff_Access_Group_Control u
			JOIN
				@TempTable t ON u.StaffId = t.StaffId;
	   END

	   IF(@ActionType = 'Remove')
	   BEGIN
	        UPDATE Tbl_Mstr_Staff_Access_Group_Control SET AccessGroupId = null WHERE StaffId IN(SELECT value FROM STRING_SPLIT(@StaffIds, ','))
	   END
END


